[tools]
python = "3.12.12"
uv = "0.10.3"
prek = "0.3.3"

[tasks.test]
description = "Run test suite with coverage"
run = "uv run pytest"
depends = ["sync"]

[tasks.lint]
description = "Run ruff linter and ty type checker"
run = ["uv run ruff check src/ tests/", "uv run ty check src/"]
depends = ["sync"]

[tasks.format]
description = "Format code with ruff"
run = "uv run ruff format src/ tests/"
depends = ["sync"]

[tasks."pre-commit"]
description = "Run pre-commit hooks on all files"
run = "prek run --all-files"
depends = ["sync"]

[tasks.sync]
description = "Install/sync all dependencies"
run = "uv sync --all-groups"

[tasks.run]
description = "Run caviardeur CLI"
run = "uv run caviardeur"
depends = ["sync"]

[tasks.build]
description = "Build wheel and sdist"
run = "uv build"
depends = ["sync"]

[tasks.package]
description = "Package as single executable with PyInstaller"
usage = 'flag "--name <name>" help="Binary name" default="caviardeur"'
run = """
uv sync --group package --no-group dev
# Strip debug symbols from onnxruntime before PyInstaller collects them
strip -x .venv/lib/python3.12/site-packages/onnxruntime/capi/*.dylib \
         .venv/lib/python3.12/site-packages/onnxruntime/capi/*.so 2>/dev/null || true
uv run --no-sync pyinstaller \
  --onefile \
  --name ${usage_name} \
  --hidden-import=openpyxl \
  --hidden-import=xlrd \
  --hidden-import=docx \
  --hidden-import=pptx \
  --hidden-import=fitz \
  --hidden-import=huggingface_hub \
  --hidden-import=sentencepiece \
  --collect-submodules=rich._unicode_data \
  --exclude-module=transformers \
  --exclude-module=torch \
  --exclude-module=hf_xet \
  --exclude-module=tokenizers \
  --exclude-module=pygments \
  --exclude-module=lxml.objectify \
  --exclude-module=xlsxwriter \
  _entry.py
"""

[tasks.tag]
description = "Bump version, commit, tag and push (default: patch bump)"
usage = '''
flag "--minor" help="Bump minor version instead of patch"
flag "--major" help="Bump major version instead of patch"
'''
run = """
python3 -c "
import sys, os, subprocess

result = subprocess.run(
    ['git', 'describe', '--tags', '--abbrev=0', '--match', 'v*.*.*'],
    capture_output=True, text=True
)
cur = result.stdout.strip().lstrip('v') if result.returncode == 0 else '0.0.0'
a, b, c = map(int, cur.split('.'))

if os.environ.get('usage_major') == 'true':
    a += 1; b = 0; c = 0
elif os.environ.get('usage_minor') == 'true':
    b += 1; c = 0
else:
    c += 1

tag = f'v{a}.{b}.{c}'
print(f'Current: v{cur}  ->  New: {tag}')

confirm = input(f'Create and push {tag}? [y/N] ')
if confirm.lower() != 'y':
    print('Aborted.')
    sys.exit(1)

subprocess.run(['git', 'tag', tag], check=True)
subprocess.run(['git', 'push', 'origin', tag], check=True)
print(f'Pushed {tag}')
"
"""

[tasks.clean]
description = "Remove build artifacts"
run = "rm -rf dist/ build/ *.spec __pycache__ .pytest_cache"

[tasks."dry-run"]
description = "Dry-run pseudonymization on test fixtures"
run = "uv run caviardeur tests/fixtures/ --dry-run"
